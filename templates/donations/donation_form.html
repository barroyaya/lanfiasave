{% extends 'base.html' %}

{% block title %}Faire un Don - LanfiaSave{% endblock %}

{% block content %}
  <div class="donation-page">
    <!-- Particles d'arri√®re-plan -->
    <div class="particles-container" id="particlesContainer"></div>

    <!-- En-t√™te avec statistiques -->
    <div class="donation-header">
      <div class="header-content">
        <h1 class="main-title">
          <i class="fas fa-heart"></i>
          Faire un Don Solidaire
        </h1>
        <p class="subtitle">Votre g√©n√©rosit√© peut changer une vie. Chaque don compte.</p>

        <!-- Mini statistiques -->
        <div class="stats-mini">
          <div class="stat-item">
            <span class="stat-number" id="totalPersonnes">0</span>
            <span class="stat-label">Personnes aid√©es</span>
          </div>
          <div class="stat-item">
            <span class="stat-number" id="totalMontant">0F</span>
            <span class="stat-label">Collect√©s ce mois</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">24h</span>
            <span class="stat-label">Validation rapide</span>
          </div>
        </div>
      </div>
    </div>

    <div class="donation-container">
      <!-- Indicateur de progression -->
      <div class="progress-indicator">
        <div class="step active" data-step="1"><i class="fas fa-info-circle"></i><span>Informations</span></div>
        <div class="step" data-step="2"><i class="fas fa-users"></i><span>B√©n√©ficiaire</span></div>
        <div class="step" data-step="3"><i class="fas fa-credit-card"></i><span>Montant</span></div>
        <div class="step" data-step="4"><i class="fas fa-check"></i><span>Confirmation</span></div>
      </div>

      <form method="post" id="don_form" class="donation-form">
        {% csrf_token %}

        <!-- √âtape 1 -->
        <div class="form-step active" data-step="1">
          <div class="step-header">
            <h3><i class="fas fa-list-alt"></i> Choisir une cat√©gorie</h3>
            <p>S√©lectionnez le type de personne que vous souhaitez aider</p>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-tag"></i> Cat√©gorie de vuln√©rabilit√©</label>
            <select name="entite_vulnerable" id="entite_vulnerable" class="form-select modern-select" required>
              <option value="">S√©lectionner une cat√©gorie...</option>
              <option value="orphelin">üßí Orphelin</option>
              <option value="veuve">üë© Veuve</option>
              <option value="handicape">‚ôø Personne handicap√©e</option>
              <option value="senior">üë¥ Personne √¢g√©e</option>
              <option value="refugie">üè† R√©fugi√©</option>
              <option value="sans_abri">üèöÔ∏è Sans-abri</option>
              <option value="famille_nombreuse">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille nombreuse</option>
              <option value="chomeur">üíº Ch√¥meur longue dur√©e</option>
              <option value="malade_chronique">üè• Malade chronique</option>
              <option value="etudiant_precaire">üéì √âtudiant en pr√©carit√©</option>
            </select>
          </div>
        </div>

        <!-- √âtape 2 -->
        <div class="form-step" data-step="2">
          <div class="step-header">
            <h3><i class="fas fa-user-friends"></i> Choisir le b√©n√©ficiaire</h3>
            <p>S√©lectionnez une personne sp√©cifique ou laissez vide pour aider toute la cat√©gorie</p>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-users"></i> Personne b√©n√©ficiaire (optionnel)</label>
            <div class="select-container">
              <select name="personne_vulnerable" id="personne_vulnerable" class="form-select" multiple>
                <option value="" disabled>Chargement des personnes...</option>
              </select>
              <div class="select-instructions">
                <i class="fas fa-info-circle"></i>
                <span><strong>S√©lection:</strong> Cliquez pour s√©lectionner une personne, maintenez Ctrl (ou Cmd sur Mac) pour en s√©lectionner plusieurs</span>
              </div>
            </div>
            <div class="form-help">
              <i class="fas fa-info-circle"></i>
              Si aucune personne n'est s√©lectionn√©e, le don sera r√©parti √©quitablement entre toutes les personnes de cette cat√©gorie.
            </div>
          </div>
          <div class="selected-persons" id="selectedPersons"></div>
        </div>

        <!-- √âtape 3 -->
        <div class="form-step" data-step="3">
          <div class="step-header">
            <h3><i class="fas fa-euro-sign"></i> Montant et d√©tails</h3>
            <p>Pr√©cisez le montant de votre don et ajoutez des informations</p>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-money-bill-wave"></i> Montant du don (‚Ç¨)</label>
            <div class="amount-input-container">
              <input type="number" name="montant" id="montant" class="form-input amount-input" min="1" step="0.01" required>
              <div class="amount-suggestions">
                <button type="button" class="amount-btn" data-amount="10">10‚Ç¨</button>
                <button type="button" class="amount-btn" data-amount="25">25‚Ç¨</button>
                <button type="button" class="amount-btn" data-amount="50">50‚Ç¨</button>
                <button type="button" class="amount-btn" data-amount="100">100‚Ç¨</button>
              </div>
            </div>
            <div class="amount-impact" id="amountImpact"></div>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-map-marker-alt"></i> Provenance du don</label>
            <input type="text" name="provenance" id="provenance" class="form-input" placeholder="Votre ville ou r√©gion" required>
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-comment-alt"></i> Message d'encouragement (optionnel)</label>
            <textarea name="description" id="description" class="form-textarea" rows="3" placeholder="Laissez un message d'encouragement pour les b√©n√©ficiaires..."></textarea>
          </div>
        </div>

        <!-- √âtape 4 -->
        <div class="form-step" data-step="4">
          <div class="step-header">
            <h3><i class="fas fa-check-circle"></i> R√©capitulatif</h3>
            <p>V√©rifiez les informations avant de finaliser votre don</p>
          </div>
          <div class="donation-summary" id="donationSummary"></div>
        </div>

        <!-- Navigation -->
        <div class="form-navigation">
          <button type="button" class="btn-nav btn-prev" id="prevBtn" style="display: none;">
            <i class="fas fa-chevron-left"></i> Pr√©c√©dent
          </button>
          <button type="button" class="btn-nav btn-next" id="nextBtn">
            Suivant <i class="fas fa-chevron-right"></i>
          </button>
          <button type="submit" class="btn-submit" id="submitBtn" style="display: none;">
            <i class="fas fa-heart"></i> Confirmer le Don
          </button>
        </div>
      </form>
    </div>

    <!-- Modal de confirmation -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal-container">
        <div class="modal-header">
          <h3><i class="fas fa-heart text-danger"></i> Merci pour votre g√©n√©rosit√© !</h3>
        </div>
        <div class="modal-body">
          <p>Votre don a √©t√© enregistr√© avec succ√®s et sera valid√© sous 24h.</p>
          <div class="confirmation-details" id="confirmationDetails"></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-primary" onclick="closeModal()">Continuer</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warm-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --card-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      --text-primary: #2c3e50;
      --text-secondary: #718096;
      --border-radius: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .donation-page {
      min-height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      position: relative;
      overflow-x: hidden;
    }

    /* Particules d'arri√®re-plan */
    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 50%;
      animation: float-particle 20s infinite linear;
    }

    @keyframes float-particle {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* En-t√™te */
    .donation-header {
      background: var(--primary-gradient);
      color: white;
      padding: 4rem 2rem 3rem;
      text-align: center;
      position: relative;
      z-index: 2;
    }

    .donation-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .header-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
      margin: 0 auto;
    }

    .main-title {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 1rem;
      animation: fadeInUp 1s ease-out;
    }

    .main-title i {
      color: #ff6b9d;
      animation: pulse 2s infinite;
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 2rem;
      animation: fadeInUp 1s ease-out 0.2s both;
    }

    .stats-mini {
      display: flex;
      justify-content: center;
      gap: 2rem;
      animation: fadeInUp 1s ease-out 0.4s both;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      display: block;
      font-size: 1.8rem;
      font-weight: 700;
      color: #ffd700;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    /* Conteneur principal */
    .donation-container {
      max-width: 800px;
      margin: -2rem auto 4rem;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      position: relative;
      z-index: 2;
      animation: slideInUp 0.8s ease-out;
    }

    /* Indicateur de progression */
    .progress-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3rem;
      position: relative;
    }

    .progress-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 25px;
      right: 25px;
      height: 2px;
      background: #e2e8f0;
      z-index: 1;
    }

    .progress-indicator::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 25px;
      height: 2px;
      background: var(--primary-gradient);
      width: 0%;
      transition: width 0.5s ease;
      z-index: 2;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      z-index: 3;
    }

    .step i {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .step.active i {
      background: var(--primary-gradient);
      color: white;
      transform: scale(1.1);
    }

    .step span {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .step.active span {
      color: var(--text-primary);
    }

    /* √âtapes du formulaire */
    .form-step {
      display: none;
      animation: fadeInRight 0.5s ease-out;
    }

    .form-step.active {
      display: block;
    }

    .step-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .step-header h3 {
      font-size: 1.5rem;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .step-header h3 i {
      color: #667eea;
      margin-right: 0.5rem;
    }

    .step-header p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Groupes de formulaire */
    .form-group {
      margin-bottom: 2rem;
    }

    .form-label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .form-label i {
      color: #667eea;
      margin-right: 0.5rem;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 1rem 1.2rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: white;
    }

    .modern-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
    }

    /* Style sp√©cifique pour le select multiple */
    select[multiple] {
      min-height: 200px;
      padding: 0.5rem;
      background-image: none;
      appearance: auto;
    }

    select[multiple] option {
      padding: 0.8rem 1rem;
      margin: 0.2rem 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--text-primary);
      background: white;
      transition: all 0.2s ease;
    }

    select[multiple] option:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    select[multiple] option:checked {
      background: #667eea;
      color: white;
      font-weight: 600;
    }

    select[multiple] option:disabled {
      color: #a0aec0;
      cursor: not-allowed;
      font-style: italic;
    }

    /* Pour les navigateurs webkit (Chrome, Safari) */
    select[multiple]::-webkit-scrollbar {
      width: 8px;
    }

    select[multiple]::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    select[multiple]::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    select[multiple]::-webkit-scrollbar-thumb:hover {
      background: #5a67d8;
    }

    .form-help {
      margin-top: 0.5rem;
      padding: 0.8rem 1rem;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-left: 3px solid #667eea;
    }

    .form-help i {
      color: #667eea;
      margin-right: 0.5rem;
    }

    /* Suggestions de montant */
    .amount-input-container {
      position: relative;
    }

    .amount-input {
      padding-right: 3rem;
    }

    .amount-suggestions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .amount-btn {
      flex: 1;
      padding: 0.8rem;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .amount-btn:hover, .amount-btn.active {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      transform: translateY(-2px);
    }

    .amount-impact {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
      border-left: 3px solid #10b981;
      display: none;
    }

    .amount-impact.show {
      display: block;
      animation: slideInUp 0.3s ease-out;
    }

    /* Personnes s√©lectionn√©es */
    .selected-persons {
      margin-top: 1.5rem;
    }

    .person-card {
      background: rgba(102, 126, 234, 0.05);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      animation: slideInLeft 0.3s ease-out;
    }

    .person-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .person-avatar {
      width: 40px;
      height: 40px;
      background: var(--primary-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .person-details h4 {
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 0.2rem;
    }

    .person-details p {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .funding-progress {
      text-align: right;
    }

    .progress-bar {
      width: 80px;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 0.3rem;
    }

    .progress-fill {
      height: 100%;
      background: var(--success-gradient);
      transition: width 0.3s ease;
    }

    /* R√©capitulatif */
    .donation-summary {
      background: rgba(102, 126, 234, 0.05);
      border-radius: 12px;
      padding: 2rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }

    .summary-item:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 2px solid rgba(102, 126, 234, 0.2);
    }

    /* Navigation */
    .form-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #e2e8f0;
    }

    .btn-nav, .btn-submit {
      padding: 1rem 2rem;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-prev {
      background: #f8f9fa;
      color: var(--text-secondary);
      border: 2px solid #e2e8f0;
    }

    .btn-prev:hover {
      background: #e2e8f0;
      transform: translateX(-3px);
    }

    .btn-next {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      margin-left: auto;
    }

    .btn-next:hover {
      transform: translateX(3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-submit {
      background: var(--warm-gradient);
      color: white;
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);
      font-size: 1.1rem;
      padding: 1.2rem 2.5rem;
      margin-left: auto;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(250, 112, 154, 0.4);
    }

    /* Container pour le select avec instructions */
    .select-container {
      position: relative;
      margin-bottom: 0.5rem;
    }

    .select-instructions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 6px;
      font-size: 0.85rem;
      color: #3b82f6;
    }

    .select-instructions i {
      font-size: 1rem;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 0;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.3);
      animation: slideInUp 0.3s ease-out;
    }

    .modal-header {
      background: var(--warm-gradient);
      color: white;
      padding: 2rem;
      text-align: center;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-actions {
      padding: 1rem 2rem 2rem;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    /* Message de validation */
    .step-validation-message {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid #f59e0b;
      color: #d97706;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.9rem;
      animation: slideInUp 0.3s ease-out;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-title {
        font-size: 2rem;
      }

      .stats-mini {
        flex-direction: column;
        gap: 1rem;
      }

      .donation-container {
        margin: -1rem 1rem 2rem;
        padding: 1.5rem;
      }

      .progress-indicator {
        flex-wrap: wrap;
        gap: 1rem;
      }

      .step {
        flex: 1;
        min-width: 80px;
      }

      .amount-suggestions {
        flex-wrap: wrap;
      }

      .form-navigation {
        flex-direction: column;
        gap: 1rem;
      }

      .btn-nav, .btn-submit {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .donation-header {
        padding: 3rem 1rem 2rem;
      }

      .step span {
        display: none;
      }

      .person-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .funding-progress {
        text-align: left;
        width: 100%;
      }

      .progress-bar {
        width: 100%;
      }
    }
  </style>

  <script>
  // Variables globales
  let currentStep = 1;
  const totalSteps = 4;
  let selectedPersons = [];
  let donationData = {};

  // Fonction pour obtenir les √©l√©ments du DOM de mani√®re s√ªre
  function getFormElements() {
    return {
      entiteField: document.getElementById('entite_vulnerable'),
      personneField: document.getElementById('personne_vulnerable'),
      montantField: document.getElementById('montant'),
      provenanceField: document.getElementById('provenance'),
      descriptionField: document.getElementById('description')
    };
  }

  // Initialisation
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM charg√©, initialisation...');
    
    createParticles();
    updateProgressIndicator();
    setupEventListeners();
    loadStats();

    // Style pour le select multiple
    const elements = getFormElements();
    if (elements.personneField) {
      elements.personneField.style.minHeight = '150px';
      elements.personneField.style.width = '100%';
    }
  });

  // Cr√©er les particules d'arri√®re-plan
  function createParticles() {
    const container = document.getElementById('particlesContainer');
    if (!container) return;

    const particleCount = 20;
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.width = particle.style.height = Math.random() * 12 + 6 + 'px';
      particle.style.animationDelay = Math.random() * 20 + 's';
      particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
      container.appendChild(particle);
    }
  }

  // Configuration des √©couteurs d'√©v√©nements
  function setupEventListeners() {
    // Navigation entre les √©tapes
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const donForm = document.getElementById('don_form');

    if (nextBtn) nextBtn.addEventListener('click', nextStep);
    if (prevBtn) prevBtn.addEventListener('click', prevStep);
    if (donForm) donForm.addEventListener('submit', function(e) {
      e.preventDefault();
      submitDonation();
    });

    // Obtenir les √©l√©ments du formulaire
    const elements = getFormElements();

    if (elements.entiteField) {
      elements.entiteField.addEventListener('change', function() {
        const entite = this.value;
        console.log('Cat√©gorie s√©lectionn√©e:', entite);
        if (entite) {
          loadPersonnesVulnerables(entite);
          validateStep(1);
        }
      });
    }

    if (elements.personneField) {
      elements.personneField.addEventListener('change', updateSelectedPersons);
    }

    // Suggestions de montant
    document.querySelectorAll('.amount-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const amount = this.dataset.amount;
        const elements = getFormElements();
        if (elements.montantField) {
          elements.montantField.value = amount;
          updateAmountButtons(amount);
          updateAmountImpact(amount);
          validateStep(3);
        }
      });
    });

    // Changement de montant
    if (elements.montantField) {
      elements.montantField.addEventListener('input', function() {
        const amount = this.value;
        updateAmountButtons(amount);
        updateAmountImpact(amount);
        validateStep(3);
      });
    }

    // Validation des champs
    if (elements.provenanceField) {
      elements.provenanceField.addEventListener('input', () => validateStep(3));
    }
  }

  // Charger les statistiques
  function loadStats() {
    // Charger les vraies statistiques depuis l'API
    fetch('/donations/stats_api/')
      .then(response => response.json())
      .then(data => {
        if (data.total_personnes !== undefined) {
          animateNumber('totalPersonnes', 0, data.total_personnes, 2000);
        }
        if (data.total_montant !== undefined) {
          animateNumber('totalMontant', 0, Math.round(data.total_montant), 2000, ' Fcfa');
        }
      })
      .catch(error => {
        console.log('Erreur chargement stats:', error);
        // Valeurs par d√©faut en cas d'erreur
        animateNumber('totalPersonnes', 0, 247, 2000);
        animateNumber('totalMontant', 0, 15420, 2000, '‚Ç¨');
      });
  }

  // Animation des nombres
  function animateNumber(elementId, start, end, duration, suffix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;

    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;

    const timer = setInterval(() => {
      current += increment;
      if (current >= end) {
        current = end;
        clearInterval(timer);
      }
      element.textContent = Math.floor(current) + suffix;
    }, 16);
  }

  // Charger les personnes vuln√©rables
  function loadPersonnesVulnerables(entite) {
    const elements = getFormElements();
    if (!elements.personneField) return;

    elements.personneField.innerHTML = '<option value="" disabled>Chargement...</option>';
    console.log('Chargement des personnes pour:', entite);

    fetch(`/donations/get_personnes_vulnerables/${entite}/`)
      .then(response => response.json())
      .then(data => {
        console.log("R√©ponse API personnes:", data);
        elements.personneField.innerHTML = '';

        if (data && data.personnes && data.personnes.length > 0) {
          // Ajouter un option d'en-t√™te informatif
          const headerOption = document.createElement('option');
          headerOption.disabled = true;
          headerOption.textContent = `--- ${data.personnes.length} personne(s) disponible(s) ---`;
          headerOption.style.fontWeight = 'bold';
          headerOption.style.color = '#667eea';
          elements.personneField.appendChild(headerOption);

          data.personnes.forEach(personne => {
            const option = document.createElement('option');
            option.value = personne.id;
            
            // Formater le texte de mani√®re plus lisible
            const nomComplet = personne.nom_complet || 'Nom inconnu';
            const username = personne.username || 'utilisateur';
            const pourcentage = personne.pourcentage_atteint || 0;
            const montantRestant = (personne.montant_requis - personne.montant_recu).toFixed(2);
            
            option.textContent = `${nomComplet} (@${username}) - ${pourcentage}% financ√© (reste ${montantRestant}‚Ç¨)`;
            option.dataset.personData = JSON.stringify(personne);
            
            // Ajouter un titre pour l'info-bulle
            option.title = `${nomComplet} - ${personne.entite || ''}\nD√©j√† re√ßu: ${personne.montant_recu}‚Ç¨ / ${personne.montant_requis}‚Ç¨\nManque: ${montantRestant}‚Ç¨`;
            
            elements.personneField.appendChild(option);
          });

          // Ajouter une note d'aide en bas
          const footerOption = document.createElement('option');
          footerOption.disabled = true;
          footerOption.textContent = '--- Cliquez pour s√©lectionner, Ctrl+Clic pour multi-s√©lection ---';
          footerOption.style.fontSize = '0.85rem';
          footerOption.style.fontStyle = 'italic';
          elements.personneField.appendChild(footerOption);
        } else {
          const noOption = document.createElement('option');
          noOption.disabled = true;
          noOption.textContent = 'Aucune personne valid√©e dans cette cat√©gorie';
          noOption.style.color = '#e53e3e';
          elements.personneField.appendChild(noOption);
        }

        // Ajuster la hauteur du select en fonction du nombre d'options
        const optionCount = elements.personneField.options.length;
        const height = Math.min(Math.max(150, optionCount * 35), 400);
        elements.personneField.style.height = height + 'px';
      })
      .catch(error => {
        console.error('Erreur:', error);
        elements.personneField.innerHTML = '<option value="" disabled style="color: #e53e3e;">Erreur de chargement</option>';
      });
  }

  // Mettre √† jour les personnes s√©lectionn√©es
  function updateSelectedPersons() {
    selectedPersons = [];
    const elements = getFormElements();
    if (!elements.personneField) return;

    const selectedOptions = Array.from(elements.personneField.selectedOptions);
    console.log('Options s√©lectionn√©es:', selectedOptions.length);

    selectedOptions.forEach(option => {
      if (option.dataset.personData) {
        const personData = JSON.parse(option.dataset.personData);
        selectedPersons.push(personData);
      }
    });

    displaySelectedPersons();
    validateStep(2);
  }

  // Afficher les personnes s√©lectionn√©es
  function displaySelectedPersons() {
    const container = document.getElementById('selectedPersons');
    if (!container) return;

    // Si pas de personnes s√©lectionn√©es, afficher le message par d√©faut
    if (selectedPersons.length === 0) {
      container.innerHTML = `
        <div class="form-help">
          <i class="fas fa-info-circle"></i>
          Aucune personne sp√©cifique s√©lectionn√©e. Le don sera r√©parti √©quitablement entre toutes les personnes de cette cat√©gorie.
        </div>
      `;
      return;
    }

    // Afficher les personnes s√©lectionn√©es
    container.innerHTML = '<h4 style="margin-bottom: 1rem; color: var(--text-primary);"><i class="fas fa-users" style="margin-right: 0.5rem;"></i>Personnes s√©lectionn√©es :</h4>';

    selectedPersons.forEach((person, index) => {
      const personCard = document.createElement('div');
      personCard.className = 'person-card';
      personCard.style.animationDelay = `${index * 0.1}s`;

      const initials = person.nom_complet.split(' ').map(n => n.charAt(0).toUpperCase()).join('');

      personCard.innerHTML = `
        <div class="person-info">
          <div class="person-avatar">
            ${initials}
          </div>
          <div class="person-details">
            <h4>${person.nom_complet}</h4>
            <p>@${person.username} ‚Ä¢ ${person.entite}</p>
            <p style="font-size: 0.75rem; color: #10b981;">
              <i class="fas fa-euro-sign" style="margin-right: 0.25rem;"></i>
              ${person.montant_recu}‚Ç¨ / ${person.montant_requis}‚Ç¨ collect√©s
            </p>
          </div>
        </div>
        <div class="funding-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${person.pourcentage_atteint}%"></div>
          </div>
          <small><strong>${person.pourcentage_atteint}%</strong> financ√©</small>
          <div style="margin-top: 0.5rem;">
            <small style="color: #ef4444;">
              <i class="fas fa-target" style="margin-right: 0.25rem;"></i>
              Encore ${(person.montant_requis - person.montant_recu).toFixed(2)}‚Ç¨ n√©cessaires
            </small>
          </div>
        </div>
      `;
      container.appendChild(personCard);
    });

    // Ajouter un r√©sum√©
    const totalPersons = selectedPersons.length;
    const totalNeeded = selectedPersons.reduce((sum, person) => sum + (person.montant_requis - person.montant_recu), 0);
    const avgProgress = selectedPersons.reduce((sum, person) => sum + person.pourcentage_atteint, 0) / totalPersons;

    const summaryCard = document.createElement('div');
    summaryCard.className = 'summary-card';
    summaryCard.style.cssText = `
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
      text-align: center;
    `;

    summaryCard.innerHTML = `
      <h5 style="margin-bottom: 0.5rem;">
        <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
        R√©sum√© de la s√©lection
      </h5>
      <div style="display: flex; justify-content: space-around; text-align: center;">
        <div>
          <div style="font-size: 1.2rem; font-weight: bold;">${totalPersons}</div>
          <div style="font-size: 0.8rem; opacity: 0.9;">Personne(s)</div>
        </div>
        <div>
          <div style="font-size: 1.2rem; font-weight: bold;">${Math.round(avgProgress)}%</div>
          <div style="font-size: 0.8rem; opacity: 0.9;">Progression moy.</div>
        </div>
        <div>
          <div style="font-size: 1.2rem; font-weight: bold;">${totalNeeded.toFixed(0)}‚Ç¨</div>
          <div style="font-size: 0.8rem; opacity: 0.9;">Total n√©cessaire</div>
        </div>
      </div>
    `;

    container.appendChild(summaryCard);
  }

  // Mettre √† jour les boutons de montant
  function updateAmountButtons(selectedAmount) {
    document.querySelectorAll('.amount-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.amount == selectedAmount) {
        btn.classList.add('active');
      }
    });
  }

  // Mettre √† jour l'impact du montant
  function updateAmountImpact(amount) {
    const impactElement = document.getElementById('amountImpact');
    if (!impactElement) return;

    if (amount && amount > 0) {
      let impactText = '';
      if (amount >= 100) {
        impactText = `<i class="fas fa-star text-warning"></i> <strong>Impact exceptionnel !</strong> Votre don peut transformer une vie enti√®re.`;
      } else if (amount >= 50) {
        impactText = `<i class="fas fa-heart text-danger"></i> <strong>Impact significatif !</strong> Votre don couvre les besoins essentiels pendant plusieurs jours.`;
      } else if (amount >= 25) {
        impactText = `<i class="fas fa-thumbs-up text-success"></i> <strong>Impact important !</strong> Votre don aide concr√®tement au quotidien.`;
      } else {
        impactText = `<i class="fas fa-smile text-primary"></i> <strong>Chaque euro compte !</strong> Votre geste solidaire fait la diff√©rence.`;
      }

      impactElement.innerHTML = impactText;
      impactElement.classList.add('show');
    } else {
      impactElement.classList.remove('show');
    }
  }

  // Navigation - √âtape suivante
  function nextStep() {
    console.log('Tentative de passage √† l\'√©tape suivante. √âtape actuelle:', currentStep);
    
    if (validateCurrentStep()) {
      if (currentStep < totalSteps) {
        currentStep++;
        console.log('Passage √† l\'√©tape:', currentStep);
        updateFormDisplay();
        updateProgressIndicator();

        if (currentStep === 4) {
          generateSummary();
        }
      }
    }
  }

  // Navigation - √âtape pr√©c√©dente
  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      console.log('Retour √† l\'√©tape:', currentStep);
      updateFormDisplay();
      updateProgressIndicator();
    }
  }

  // Valider une √©tape sp√©cifique
  function validateStep(step) {
    const elements = getFormElements();
    let isValid = false;

    switch (step) {
      case 1:
        isValid = elements.entiteField && elements.entiteField.value !== '';
        console.log(`Validation √©tape 1: ${isValid ? '‚úÖ' : '‚ùå'} (entit√©: "${elements.entiteField ? elements.entiteField.value : ''}")`);
        break;
      case 2:
        // L'√©tape 2 est toujours valide car la s√©lection de personne est optionnelle
        isValid = true;
        console.log(`Validation √©tape 2: ‚úÖ (s√©lection optionnelle)`);
        break;
      case 3:
        const montantValid = elements.montantField && elements.montantField.value && parseFloat(elements.montantField.value) > 0;
        const provenanceValid = elements.provenanceField && elements.provenanceField.value.trim() !== '';
        isValid = montantValid && provenanceValid;
        console.log(`Validation √©tape 3: ${isValid ? '‚úÖ' : '‚ùå'} (montant: ${montantValid ? '‚úÖ' : '‚ùå'}, provenance: ${provenanceValid ? '‚úÖ' : '‚ùå'})`);
        break;
      case 4:
        isValid = true;
        console.log(`Validation √©tape 4: ‚úÖ (r√©capitulatif)`);
        break;
      default:
        isValid = false;
        console.log(`Validation √©tape ${step}: ‚ùå (√©tape inconnue)`);
    }

    return isValid;
  }

  // Valider l'√©tape actuelle avec feedback visuel
  function validateCurrentStep() {
    const isValid = validateStep(currentStep);
    console.log(`Validation de l'√©tape ${currentStep}: ${isValid ? 'valide' : 'invalide'}`);

    if (!isValid) {
      // Afficher un message d'aide selon l'√©tape
      let helpMessage = '';
      const elements = getFormElements();
      
      switch (currentStep) {
        case 1:
          helpMessage = 'Veuillez s√©lectionner une cat√©gorie de vuln√©rabilit√©.';
          break;
        case 3:
          if (!elements.montantField || !elements.montantField.value || parseFloat(elements.montantField.value) <= 0) {
            helpMessage = 'Veuillez saisir un montant sup√©rieur √† 0‚Ç¨.';
          } else if (!elements.provenanceField || !elements.provenanceField.value.trim()) {
            helpMessage = 'Veuillez indiquer la provenance de votre don.';
          }
          break;
      }

      if (helpMessage) {
        showStepValidationMessage(helpMessage);
      }
    }

    return isValid;
  }

  // Afficher un message de validation pour l'√©tape
  function showStepValidationMessage(message) {
    // Supprimer les anciens messages
    const existingMessages = document.querySelectorAll('.step-validation-message');
    existingMessages.forEach(msg => msg.remove());

    // Cr√©er le nouveau message
    const messageElement = document.createElement('div');
    messageElement.className = 'step-validation-message';
    messageElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>${message}`;

    // L'ajouter apr√®s le form-step actuel
    const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    if (currentStepElement) {
      currentStepElement.appendChild(messageElement);
    }

    // Le faire dispara√Ætre apr√®s 5 secondes
    setTimeout(() => {
      if (messageElement.parentNode) {
        messageElement.style.opacity = '0';
        setTimeout(() => messageElement.remove(), 300);
      }
    }, 5000);
  }

  // Mettre √† jour l'affichage du formulaire
  function updateFormDisplay() {
    console.log('Mise √† jour de l\'affichage pour l\'√©tape:', currentStep);
    
    // Masquer toutes les √©tapes
    document.querySelectorAll('.form-step').forEach(step => {
      step.classList.remove('active');
    });

    // Afficher l'√©tape actuelle
    const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    if (currentStepElement) {
      currentStepElement.classList.add('active');
      console.log('√âtape affich√©e:', currentStep);
    }

    // Mettre √† jour les boutons de navigation
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');

    if (prevBtn) prevBtn.style.display = currentStep > 1 ? 'flex' : 'none';

    if (currentStep === totalSteps) {
      if (nextBtn) nextBtn.style.display = 'none';
      if (submitBtn) submitBtn.style.display = 'flex';
    } else {
      if (nextBtn) nextBtn.style.display = 'flex';
      if (submitBtn) submitBtn.style.display = 'none';
    }
  }

  // Mettre √† jour l'indicateur de progression
  function updateProgressIndicator() {
    // Mettre √† jour les √©tapes
    document.querySelectorAll('.progress-indicator .step').forEach((step, index) => {
      step.classList.remove('active');
      if (index + 1 <= currentStep) {
        step.classList.add('active');
      }
    });

    // Calcul de la progression en pourcentage
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;

    // Mettre √† jour la barre de progression
    const progressIndicator = document.querySelector('.progress-indicator');
    if (progressIndicator) {
      const progressBar = progressIndicator.querySelector('::after') || progressIndicator;
      progressIndicator.style.setProperty('--progress-width', progressPercentage + '%');
    }
  }

  // G√©n√©rer le r√©capitulatif
  function generateSummary() {
    const summaryContainer = document.getElementById('donationSummary');
    if (!summaryContainer) return;

    const elements = getFormElements();
    const entiteText = elements.entiteField ? elements.entiteField.options[elements.entiteField.selectedIndex].text : '';
    const montant = elements.montantField ? elements.montantField.value : '';
    const provenance = elements.provenanceField ? elements.provenanceField.value : '';
    const description = elements.descriptionField ? elements.descriptionField.value : '';

    let beneficiairesText = 'Toutes les personnes de cette cat√©gorie';
    if (selectedPersons.length > 0) {
      beneficiairesText = selectedPersons.map(p => p.nom_complet).join(', ');
    }

    summaryContainer.innerHTML = `
      <div class="summary-item">
        <span><i class="fas fa-tag"></i> Cat√©gorie</span>
        <strong>${entiteText}</strong>
      </div>
      <div class="summary-item">
        <span><i class="fas fa-users"></i> B√©n√©ficiaires</span>
        <strong>${beneficiairesText}</strong>
      </div>
      <div class="summary-item">
        <span><i class="fas fa-euro-sign"></i> Montant</span>
        <strong>${montant}‚Ç¨</strong>
      </div>
      <div class="summary-item">
        <span><i class="fas fa-map-marker-alt"></i> Provenance</span>
        <strong>${provenance}</strong>
      </div>
      ${description ? `
      <div class="summary-item">
        <span><i class="fas fa-comment-alt"></i> Message</span>
        <strong>"${description}"</strong>
      </div>
      ` : ''}
      <div class="summary-item">
        <span><i class="fas fa-heart"></i> Total de votre don</span>
        <strong style="color: #fa709a; font-size: 1.3rem;">${montant}‚Ç¨</strong>
      </div>
    `;
  }

  function submitDonation() {
  const form = document.getElementById('don_form');
  if (!form) return;

  const formData = new FormData(form);

  // ‚úÖ Corriger l'envoi multiple
  const selectedPeople = Array.from(form.querySelectorAll('[name="personne_vulnerable"] option:checked')).map(opt => opt.value);
  formData.delete('personne_vulnerable');
  selectedPeople.forEach(id => {
    formData.append('personne_vulnerable', id);
  });

  const loadingBtn = document.getElementById('submitBtn');
  if (!loadingBtn) return;

  loadingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
  loadingBtn.disabled = true;

  fetch(window.location.href, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
    .then(response => {
      if (response.ok || response.redirected) {
        showSuccessModal();
      } else {
        throw new Error('Erreur lors de la soumission');
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      showErrorNotification('Une erreur est survenue. Veuillez r√©essayer.');
      loadingBtn.innerHTML = '<i class="fas fa-heart"></i> Confirmer le Don';
      loadingBtn.disabled = false;
    });
}


  // Afficher la modal de succ√®s
  function showSuccessModal() {
    const modal = document.getElementById('confirmModal');
    const details = document.getElementById('confirmationDetails');
    if (!modal || !details) return;

    const elements = getFormElements();
    const montant = elements.montantField ? elements.montantField.value : '';

    details.innerHTML = `
      <div style="text-align: center; margin-top: 1rem;">
        <div style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;">
          <i class="fas fa-check-circle"></i>
        </div>
        <p><strong>Montant:</strong> ${montant}‚Ç¨</p>
        <p><strong>R√©f√©rence:</strong> DON-${Date.now().toString().slice(-6)}</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
          Vous recevrez une confirmation par email dans quelques minutes.
        </p>
      </div>
    `;

    modal.classList.add('active');
  }

  // Fermer la modal
  function closeModal() {
    const modal = document.getElementById('confirmModal');
    if (!modal) return;

    modal.classList.remove('active');
    // Rediriger vers la page de profil
    setTimeout(() => {
      window.location.href = '/users/profile/';
    }, 500);
  }

  // Afficher une notification d'erreur
  function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: all 0.5s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    `;
    notification.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>${message}`;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
    }, 100);

    setTimeout(() => {
      notification.style.transform = 'translateX(400px)';
      setTimeout(() => document.body.removeChild(notification), 500);
    }, 4000);
  }

  // Ajout du CSS dynamique pour la barre de progression
  document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
      .progress-indicator {
        --progress-width: 0%;
      }
      .progress-indicator::after {
        width: var(--progress-width) !important;
      }
    `;
    document.head.appendChild(style);
  });
  </script>

{% endblock %}


{##}
{#{% extends 'base.html' %}#}
{##}
{#{% block title %}Faire un Don - LanfiaSave{% endblock %}#}
{##}
{#{% block content %}#}
{#  <div class="donation-container">#}
{#    <h2>Faire un Don</h2>#}
{#    <form method="post" id="don_form" class="donation-form">#}
{#      {% csrf_token %}#}
{#      <div class="form-group">#}
{#        {{ form.as_p }}#}
{#      </div>#}
{#      <button type="submit" class="btn-submit">Faire un Don</button>#}
{#    </form>#}
{#  </div>#}
{##}
{#  <script>#}
{#    // S√©lectionner les √©l√©ments du formulaire#}
{#    const entiteField = document.querySelector('select[name="entite_vulnerable"]');#}
{#    const personneField = document.querySelector('select[name="personne_vulnerable"]');#}
{#    const montantField = document.querySelector('input[name="montant"]');#}
{##}
{#    // Fonction pour charger les personnes vuln√©rables en fonction de l'entit√© s√©lectionn√©e#}
{#    function loadPersonnesVulnerables(entite) {#}
{#    fetch(`/donations/get_personnes_vulnerables/${entite}/`)#}
{#        .then(response => response.json())#}
{#        .then(data => {#}
{#            personneField.innerHTML = '';  #}
{##}
{#            const defaultOption = document.createElement('option');#}
{#            defaultOption.value = '';#}
{#            defaultOption.textContent = 'S√©lectionner une personne';#}
{#            personneField.appendChild(defaultOption);#}
{##}
{#            if (data && data.personnes && data.personnes.length > 0) {#}
{#                data.personnes.forEach(personne => {#}
{#                    const option = document.createElement('option');#}
{#                    option.value = personne.id;#}
{#                    // Afficher le nom complet + nom d'utilisateur + pourcentage d'aide re√ßue#}
{#                    option.textContent = `${personne.nom_complet} (@${personne.username}) - ${personne.pourcentage_atteint}% financ√©`;#}
{#                    personneField.appendChild(option);#}
{#                });#}
{#            } else {#}
{#                const noOption = document.createElement('option');#}
{#                noOption.disabled = true;#}
{#                noOption.textContent = 'Aucune personne vuln√©rable valid√©e pour cette cat√©gorie';#}
{#                personneField.appendChild(noOption);#}
{#            }#}
{#        })#}
{#        .catch(error => console.error('Erreur lors du chargement des personnes vuln√©rables:', error));#}
{#}#}
{##}
{#    // Ajouter un √©v√©nement pour quand l'entit√© est chang√©e#}
{#    entiteField.addEventListener('change', function() {#}
{#        const entite = entiteField.value;#}
{#        loadPersonnesVulnerables(entite);  // Charger les personnes vuln√©rables pour l'entit√© s√©lectionn√©e#}
{#    });#}
{##}
{#    // Charger les personnes vuln√©rables si une entit√© est d√©j√† s√©lectionn√©e lors de l'affichage du formulaire#}
{#    if (entiteField.value) {#}
{#        loadPersonnesVulnerables(entiteField.value);#}
{#    }#}
{##}
{#    // Lorsque la personne vuln√©rable est s√©lectionn√©e, ajuster le montant √† r√©partir#}
{#    personneField.addEventListener('change', function() {#}
{#        const personnesSelectionnees = personneField.selectedOptions.length;#}
{#        const montant = parseFloat(montantField.value);#}
{##}
{#        if (personnesSelectionnees > 0 && montant > 0) {#}
{#            const montantParPersonne = montant / personnesSelectionnees;#}
{#            console.log(`Montant par personne : ${montantParPersonne}`);#}
{#        } else if (montant > 0) {#}
{#            const entite = entiteField.value;#}
{#            fetch(`/donations/get_personnes_vulnerables/${entite}/`)#}
{#                .then(response => response.json())#}
{#                .then(data => {#}
{#                    const personnes = data.personnes;#}
{#                    const montantParPersonne = montant / personnes.length;#}
{#                    console.log(`Montant par personne (divis√© parmi toutes) : ${montantParPersonne}`);#}
{#                })#}
{#                .catch(error => console.error('Erreur lors du calcul du montant par personne', error));#}
{#        }#}
{#    });#}
{#  </script>#}
{##}
{#  <style>#}
{#    /* Conteneur principal */#}
{#    .donation-container {#}
{#        width: 100%;#}
{#        max-width: 800px;#}
{#        margin: 0 auto;#}
{#        padding: 40px;#}
{#        background: rgba(255, 255, 255, 0.8); /* Couleur l√©g√®rement blanche et translucide */#}
{#        color: #333; /* Texte sombre */#}
{#        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15); /* Ombre subtile mais pr√©sente */#}
{#        border-radius: 10px;#}
{#        text-align: center;#}
{#        animation: fadeIn 1s ease-out;#}
{#    }#}
{##}
{#    h2 {#}
{#        font-size: 2rem;#}
{#        color: #333;#}
{#        margin-bottom: 20px;#}
{#    }#}
{##}
{#    /* Styles pour le formulaire */#}
{#    .donation-form {#}
{#        width: 100%;#}
{#        margin: 0 auto;#}
{#        animation: slideIn 0.5s ease-out;#}
{#    }#}
{##}
{#    .form-group {#}
{#        margin-bottom: 20px;#}
{#        text-align: left;#}
{#    }#}
{##}
{#    /* Champ de saisie */#}
{#    input, select {#}
{#        width: 100%;#}
{#        padding: 12px;#}
{#        font-size: 1rem;#}
{#        border: 1px solid #ddd;#}
{#        border-radius: 8px;#}
{#        margin-top: 8px;#}
{#        box-sizing: border-box;#}
{#        transition: border-color 0.3s ease;#}
{#        background-color: rgba(50, 50, 50, 0.1); /* Fond l√©g√®rement sombre pour les champs */#}
{#        color: #333; /* Texte sombre */#}
{#    }#}
{##}
{#    input:focus, select:focus {#}
{#        outline: none;#}
{#        border-color: #3498db; /* Bordure bleue au focus */#}
{#    }#}
{##}
{#    /* Bouton de soumission */#}
{#    .btn-submit {#}
{#        width: 100%;#}
{#        padding: 12px;#}
{#        font-size: 1.1rem;#}
{#        color: #fff;#}
{#        background-color: #3498db; /* Bleu clair pour le bouton */#}
{#        border: none;#}
{#        border-radius: 8px;#}
{#        cursor: pointer;#}
{#        transition: background-color 0.3s ease, transform 0.3s ease;#}
{#    }#}
{##}
{#    .btn-submit:hover {#}
{#        background-color: #2980b9;#}
{#        transform: translateY(-3px); /* L√©g√®re animation au survol */#}
{#    }#}
{##}
{#    /* Animation d'apparition du formulaire */#}
{#    @keyframes slideIn {#}
{#        0% {#}
{#            opacity: 0;#}
{#            transform: translateY(20px);#}
{#        }#}
{#        100% {#}
{#            opacity: 1;#}
{#            transform: translateY(0);#}
{#        }#}
{#    }#}
{##}
{#    /* Animation de la page d'inscription */#}
{#    @keyframes fadeIn {#}
{#        0% {#}
{#            opacity: 0;#}
{#        }#}
{#        100% {#}
{#            opacity: 1;#}
{#        }#}
{#    }#}
{##}
{#    /* Responsivit√© */#}
{#    @media (max-width: 480px) {#}
{#        .donation-container {#}
{#            padding: 20px;#}
{#        }#}
{##}
{#        h2 {#}
{#            font-size: 1.5rem;#}
{#        }#}
{#    }#}
{#  </style>#}
{##}
{#{% endblock %}#}


{#{% extends 'base.html' %}#}
{##}
{#{% block title %}Faire un Don - LanfiaSave{% endblock %}#}
{##}
{#{% block content %}#}
{#  <div class="donation-container">#}
{#    <h2>Faire un Don</h2>#}
{#    <form method="post" id="don_form" class="donation-form">#}
{#      {% csrf_token %}#}
{#      <div class="form-group">#}
{#       #}
{#        {{form.as_p}}#}
{#      </div>#}
{#      <button type="submit" class="btn-submit">Faire un Don</button>#}
{#    </form>#}
{#  </div>#}
{##}
{#  <script>#}
{#    // S√©lectionner les √©l√©ments du formulaire#}
{#    const entiteField = document.querySelector('select[name="entite_vulnerable"]');#}
{#    const personneField = document.querySelector('select[name="personne_vulnerable"]');#}
{##}
{#    // Fonction pour charger les personnes vuln√©rables#}
{#    function loadPersonnesVulnerables(entite) {#}
{#        fetch(`/donations/get_personnes_vulnerables/${entite}/`)  // Requ√™te √† l'API pour r√©cup√©rer les personnes vuln√©rables#}
{#            .then(response => response.json())#}
{#            .then(data => {#}
{#                // Vider le champ des personnes vuln√©rables avant d'ajouter les nouvelles options#}
{#                personneField.innerHTML = '';  #}
{##}
{#                // Ajouter une option vide par d√©faut#}
{#                const defaultOption = document.createElement('option');#}
{#                defaultOption.value = '';#}
{#                defaultOption.textContent = 'S√©lectionner une personne';#}
{#                personneField.appendChild(defaultOption);#}
{##}
{#                // V√©rifier que les donn√©es sont pr√©sentes et que 'personnes' n'est pas vide#}
{#                if (data && data.personnes) {#}
{#                    // Ajouter chaque personne vuln√©rable comme option#}
{#                    data.personnes.forEach(personne => {#}
{#                        const option = document.createElement('option');#}
{#                        option.value = personne.id;  // L'ID de la personne vuln√©rable#}
{#                        option.textContent = `${personne.nom_complet}`;  // Affichage du username de la personne#}
{#                        personneField.appendChild(option);#}
{#                    });#}
{#                } else {#}
{#                    // Afficher un message si aucune personne vuln√©rable n'est trouv√©e#}
{#                    const noOption = document.createElement('option');#}
{#                    noOption.disabled = true;#}
{#                    noOption.textContent = 'Aucune personne vuln√©rable disponible pour cette entit√©';#}
{#                    personneField.appendChild(noOption);#}
{#                }#}
{#            })#}
{#            .catch(error => console.error('Erreur lors du chargement des personnes vuln√©rables:', error));#}
{#    }#}
{##}
{#    // Ajouter un √©v√©nement pour quand l'entit√© est chang√©e#}
{#    entiteField.addEventListener('change', function() {#}
{#        const entite = entiteField.value;#}
{#        loadPersonnesVulnerables(entite);  // Charger les personnes vuln√©rables pour l'entit√© s√©lectionn√©e#}
{#    });#}
{##}
{#    // Charger les personnes vuln√©rables si une entit√© est d√©j√† s√©lectionn√©e lors de l'affichage du formulaire#}
{#    if (entiteField.value) {#}
{#        loadPersonnesVulnerables(entiteField.value);#}
{#    }#}
{#  </script>#}
{##}
{#  <style>#}
{#    /* Conteneur principal */#}
{#    .donation-container {#}
{#        width: 100%;#}
{#        max-width: 800px;#}
{#        margin: 0 auto;#}
{#        padding: 40px;#}
{#        background: rgba(255, 255, 255, 0.8); /* Couleur l√©g√®rement blanche et translucide */#}
{#        color: #333; /* Texte sombre */#}
{#        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15); /* Ombre subtile mais pr√©sente */#}
{#        border-radius: 10px;#}
{#        text-align: center;#}
{#        animation: fadeIn 1s ease-out;#}
{#    }#}
{##}
{#    h2 {#}
{#        font-size: 2rem;#}
{#        color: #333;#}
{#        margin-bottom: 20px;#}
{#    }#}
{##}
{#    /* Styles pour le formulaire */#}
{#    .donation-form {#}
{#        width: 100%;#}
{#        margin: 0 auto;#}
{#        animation: slideIn 0.5s ease-out;#}
{#    }#}
{##}
{#    .form-group {#}
{#        margin-bottom: 20px;#}
{#        text-align: left;#}
{#    }#}
{##}
{#    /* Champ de saisie */#}
{#    input, select {#}
{#        width: 100%;#}
{#        padding: 12px;#}
{#        font-size: 1rem;#}
{#        border: 1px solid #ddd;#}
{#        border-radius: 8px;#}
{#        margin-top: 8px;#}
{#        box-sizing: border-box;#}
{#        transition: border-color 0.3s ease;#}
{#        background-color: rgba(50, 50, 50, 0.1); /* Fond l√©g√®rement sombre pour les champs */#}
{#        color: #333; /* Texte sombre */#}
{#    }#}
{##}
{#    input:focus, select:focus {#}
{#        outline: none;#}
{#        border-color: #3498db; /* Bordure bleue au focus */#}
{#    }#}
{##}
{#    /* Bouton de soumission */#}
{#    .btn-submit {#}
{#        width: 100%;#}
{#        padding: 12px;#}
{#        font-size: 1.1rem;#}
{#        color: #fff;#}
{#        background-color: #3498db; /* Bleu clair pour le bouton */#}
{#        border: none;#}
{#        border-radius: 8px;#}
{#        cursor: pointer;#}
{#        transition: background-color 0.3s ease, transform 0.3s ease;#}
{#    }#}
{##}
{#    .btn-submit:hover {#}
{#        background-color: #2980b9;#}
{#        transform: translateY(-3px); /* L√©g√®re animation au survol */#}
{#    }#}
{##}
{#    /* Animation d'apparition du formulaire */#}
{#    @keyframes slideIn {#}
{#        0% {#}
{#            opacity: 0;#}
{#            transform: translateY(20px);#}
{#        }#}
{#        100% {#}
{#            opacity: 1;#}
{#            transform: translateY(0);#}
{#        }#}
{#    }#}
{##}
{#    /* Animation de la page d'inscription */#}
{#    @keyframes fadeIn {#}
{#        0% {#}
{#            opacity: 0;#}
{#        }#}
{#        100% {#}
{#            opacity: 1;#}
{#        }#}
{#    }#}
{##}
{#    /* Responsivit√© */#}
{#    @media (max-width: 480px) {#}
{#        .donation-container {#}
{#            padding: 20px;#}
{#        }#}
{##}
{#        h2 {#}
{#            font-size: 1.5rem;#}
{#        }#}
{#    }#}
{#  </style>#}
{##}
{#{% endblock %}#}




{##}
{##}
{#{% extends 'base.html' %}#}
{##}
{#{% block title %}Faire un Don - LanfiaSave{% endblock %}#}
{##}
{#{% block content %}#}
{#  <h2>Faire un Don</h2>#}
{#  <form method="post" id="don_form">#}
{#    {% csrf_token %}#}
{#    {{ form.as_p }}#}
{#    <button type="submit">Faire un Don</button>#}
{#  </form>#}
{##}
{# <script>#}
{#// S√©lectionner les √©l√©ments du formulaire#}
{#const entiteField = document.querySelector('select[name="entite_vulnerable"]');#}
{#const personneField = document.querySelector('select[name="personne_vulnerable"]');#}
{##}
{#// Fonction pour charger les personnes vuln√©rables#}
{#function loadPersonnesVulnerables(entite) {#}
{#    fetch(`/donations/get_personnes_vulnerables/${entite}/`)  // Requ√™te √† l'API pour r√©cup√©rer les personnes vuln√©rables#}
{#        .then(response => response.json())#}
{#        .then(data => {#}
{#            // Vider le champ des personnes vuln√©rables avant d'ajouter les nouvelles options#}
{#            personneField.innerHTML = '';  #}
{##}
{#            // Ajouter une option vide par d√©faut#}
{#            const defaultOption = document.createElement('option');#}
{#            defaultOption.value = '';#}
{#            defaultOption.textContent = 'S√©lectionner une personne';#}
{#            personneField.appendChild(defaultOption);#}
{##}
{#            // V√©rifier que les donn√©es sont pr√©sentes et que 'personnes' n'est pas vide#}
{#            if (data && data.personnes) {#}
{#                // Ajouter chaque personne vuln√©rable comme option#}
{#                data.personnes.forEach(personne => {#}
{#                    const option = document.createElement('option');#}
{#                    option.value = personne.id;  // L'ID de la personne vuln√©rable#}
{#                    option.textContent = `${personne.username}`;  // Affichage du username de la personne#}
{#                    personneField.appendChild(option);#}
{#                });#}
{#            } else {#}
{#                // Afficher un message si aucune personne vuln√©rable n'est trouv√©e#}
{#                const noOption = document.createElement('option');#}
{#                noOption.disabled = true;#}
{#                noOption.textContent = 'Aucune personne vuln√©rable disponible pour cette entit√©';#}
{#                personneField.appendChild(noOption);#}
{#            }#}
{#        })#}
{#        .catch(error => console.error('Erreur lors du chargement des personnes vuln√©rables:', error));#}
{#}#}
{##}
{#// Ajouter un √©v√©nement pour quand l'entit√© est chang√©e#}
{#entiteField.addEventListener('change', function() {#}
{#    const entite = entiteField.value;#}
{#    loadPersonnesVulnerables(entite);  // Charger les personnes vuln√©rables pour l'entit√© s√©lectionn√©e#}
{#});#}
{##}
{#// Charger les personnes vuln√©rables si une entit√© est d√©j√† s√©lectionn√©e lors de l'affichage du formulaire#}
{#if (entiteField.value) {#}
{#    loadPersonnesVulnerables(entiteField.value);#}
{#}#}
{#</script>#}
{##}
{##}
{#{% endblock %}#}
