{#templates/formation/admin/lancer_analyses_lot.html#}

{% extends 'formation/base_formation.html' %}
{% load static %}

{% block title %}Lancer Analyses IA en Lot{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">/</span>
<a href="{% url 'formation:admin_dashboard' %}" class="breadcrumb-item">Admin</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Analyses en lot</span>
{% endblock %}

{% block formation_content %}
<div class="analyses-lot-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h2 class="page-title">
                <i class="fas fa-brain"></i>
                Lancer Analyses IA en Lot
            </h2>
            <p class="page-subtitle">
                Sélectionnez les demandes à analyser automatiquement par l'IA
            </p>
        </div>
        
        <div class="header-actions">
            <button type="button" class="btn btn-info" onclick="testIaConnection()">
                <i class="fas fa-wifi"></i> Tester IA
            </button>
            <a href="{% url 'formation:admin_configuration_ia' %}" class="btn btn-secondary">
                <i class="fas fa-cog"></i> Configuration
            </a>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="quick-actions-section">
        <div class="action-card action-danger">
            <div class="action-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="action-content">
                <h4>Analyser TOUTES les demandes en attente</h4>
                <p>Lance l'analyse IA sur toutes les demandes en attente d'un coup</p>
                <form method="post" action="{% url 'formation:admin_analyser_toutes_demandes' %}" 
                      onsubmit="return confirm('⚠️ ATTENTION : Cette action va analyser TOUTES les demandes en attente. Confirmer ?')">
                    {% csrf_token %}
                    <input type="hidden" name="confirmation" value="CONFIRME">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-rocket"></i> Analyser tout
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Demandes sans analyse -->
    {% if demandes_sans_analyse %}
    <div class="demandes-section">
        <h3 class="section-title">
            <i class="fas fa-exclamation-circle text-warning"></i>
            Demandes en attente d'analyse ({{ demandes_sans_analyse|length }})
        </h3>
        
        <form method="post" id="form-analyses-lot">
            {% csrf_token %}
            
            <div class="selection-controls">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAll('sans-analyse')">
                    <i class="fas fa-check-square"></i> Tout sélectionner
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAll('sans-analyse')">
                    <i class="fas fa-square"></i> Tout désélectionner
                </button>
                <span class="selection-count">
                    <span id="count-sans-analyse">0</span> sélectionnée(s)
                </span>
            </div>
            
            <div class="demandes-grid">
                {% for demande in demandes_sans_analyse %}
                <div class="demande-card">
                    <div class="demande-checkbox">
                        <input type="checkbox" 
                               name="demandes_selected" 
                               value="{{ demande.id }}"
                               id="demande-{{ demande.id }}"
                               class="checkbox-sans-analyse"
                               onchange="updateCount()">
                        <label for="demande-{{ demande.id }}"></label>
                    </div>
                    
                    <div class="demande-info">
                        <h5>{{ demande.personne.get_full_name }}</h5>
                        <p class="formation-name">{{ demande.formation_souhaitee.nom }}</p>
                        <div class="demande-meta">
                            <span class="meta-item">
                                <i class="fas fa-calendar"></i>
                                {{ demande.date_demande|date:"d/m/Y" }}
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-tag"></i>
                                {{ demande.formation_souhaitee.get_type_formation_display }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="demande-actions">
                        <button type="button" 
                                class="btn btn-sm btn-primary"
                                onclick="analyserUneSeule('{{ demande.id }}')"
                                id="btn-analyze-{{ demande.id }}">
                            <i class="fas fa-brain"></i> Analyser
                        </button>
                        <a href="{% url 'formation:admin_demande_detail' demande.id %}" 
                           class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-success btn-lg" id="btn-submit-lot">
                    <i class="fas fa-brain"></i> 
                    Analyser les demandes sélectionnées
                    (<span id="submit-count">0</span>)
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Demandes avec analyse ancienne -->
    {% if demandes_analyse_ancienne %}
    <div class="demandes-section">
        <h3 class="section-title">
            <i class="fas fa-clock text-info"></i>
            Demandes avec analyse ancienne ({{ demandes_analyse_ancienne|length }})
        </h3>
        
        <div class="info-banner">
            <i class="fas fa-info-circle"></i>
            Ces demandes ont une analyse IA datant de plus de 30 jours. 
            Vous pouvez les réanalyser pour tenir compte d'éventuelles améliorations du modèle.
        </div>
        
        <div class="demandes-grid">
            {% for demande in demandes_analyse_ancienne %}
            <div class="demande-card demande-ancienne">
                <div class="demande-info">
                    <h5>{{ demande.personne.get_full_name }}</h5>
                    <p class="formation-name">{{ demande.formation_souhaitee.nom }}</p>
                    <div class="demande-meta">
                        <span class="meta-item">
                            <i class="fas fa-brain"></i>
                            Score actuel: {{ demande.score_formabilite }}/100
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-calendar"></i>
                            Analysé le {{ demande.date_analyse|date:"d/m/Y" }}
                        </span>
                    </div>
                </div>
                
                <div class="demande-actions">
                    <button type="button" 
                            class="btn btn-sm btn-warning"
                            onclick="reanalyser('{{ demande.id }}')"
                            id="btn-reanalyze-{{ demande.id }}">
                        <i class="fas fa-redo"></i> Réanalyser
                    </button>
                    <a href="{% url 'formation:analyse_ia_detail' demande.id %}" 
                       class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-brain"></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- État vide -->
    {% if not demandes_sans_analyse and not demandes_analyse_ancienne %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3>Toutes les analyses sont à jour !</h3>
        <p>
            Toutes les demandes ont été analysées par l'IA. 
            <br>
            <a href="{% url 'formation:admin_demandes_list' %}">Voir toutes les demandes</a>
        </p>
    </div>
    {% endif %}
</div>

<!-- Modal de progression -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain"></i> Analyse IA en cours...
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="analysisProgress" style="width: 0%"></div>
                </div>
                <div id="progressText">Initialisation...</div>
                <div id="progressResults" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeProgressBtn" 
                        data-bs-dismiss="modal" style="display: none;">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.analyses-lot-container {
    max-width: 1400px;
    margin: 0 auto;
}

.page-header {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    padding: 30px;
    border-radius: 16px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.page-subtitle {
    margin: 0;
    opacity: 0.9;
}

.header-actions {
    display: flex;
    gap: 15px;
}

.btn {
    padding: 10px 20px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-primary { background: #3b82f6; color: white; }
.btn-secondary { background: #6b7280; color: white; }
.btn-success { background: #10b981; color: white; }
.btn-danger { background: #ef4444; color: white; }
.btn-warning { background: #f59e0b; color: white; }
.btn-info { background: #06b6d4; color: white; }

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    color: white;
}

.quick-actions-section {
    margin-bottom: 40px;
}

.action-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
}

.action-danger {
    border-color: #fecaca;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}

.action-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #ef4444;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.action-content h4 {
    color: #1f2937;
    margin-bottom: 8px;
}

.action-content p {
    color: #6b7280;
    margin-bottom: 15px;
}

.section-title {
    font-size: 1.4rem;
    color: #1f2937;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 10px;
}

.selection-controls {
    background: #f9fafb;
    padding: 15px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.selection-count {
    margin-left: auto;
    font-weight: 600;
    color: #374151;
}

.demandes-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.demande-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s;
}

.demande-card:hover {
    border-color: #8b5cf6;
    transform: translateY(-2px);
}

.demande-ancienne {
    border-color: #fbbf24;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
}

.demande-checkbox {
    position: relative;
}

.demande-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin: 0;
}

.demande-info {
    flex: 1;
}

.demande-info h5 {
    color: #1f2937;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.formation-name {
    color: #6b7280;
    margin-bottom: 10px;
    font-weight: 500;
}

.demande-meta {
    display: flex;
    gap: 15px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85rem;
    color: #6b7280;
}

.meta-item i {
    color: #8b5cf6;
}

.demande-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
}

.btn-outline-secondary {
    border-color: #6b7280;
    color: #6b7280;
    background: transparent;
}

.btn-outline-secondary:hover {
    background: #6b7280;
    color: white;
}

.btn-outline-primary {
    border-color: #3b82f6;
    color: #3b82f6;
    background: transparent;
}

.btn-outline-primary:hover {
    background: #3b82f6;
    color: white;
}

.form-actions {
    text-align: center;
    padding: 30px;
    background: #f9fafb;
    border-radius: 12px;
}

.btn-lg {
    padding: 15px 30px;
    font-size: 1.1rem;
}

.info-banner {
    background: #dbeafe;
    border: 1px solid #3b82f6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #1e40af;
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #10b981;
}

.empty-state h3 {
    color: #1f2937;
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .selection-controls {
        flex-direction: column;
        gap: 10px;
    }
    
    .demande-card {
        flex-direction: column;
        text-align: center;
    }
    
    .demande-meta {
        justify-content: center;
    }
}
</style>

<script>
// Variables globales
let selectedCount = 0;

// Fonction pour obtenir le token CSRF
function getCSRFToken() {
    const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!tokenElement) {
        console.error('Token CSRF non trouvé');
        return null;
    }
    return tokenElement.value;
}

// Fonction pour sélectionner toutes les checkboxes
function selectAll(className) {
    const checkboxes = document.querySelectorAll('.checkbox-' + className);
    checkboxes.forEach(cb => {
        cb.checked = true;
    });
    updateCount();
}

// Fonction pour désélectionner toutes les checkboxes
function deselectAll(className) {
    const checkboxes = document.querySelectorAll('.checkbox-' + className);
    checkboxes.forEach(cb => {
        cb.checked = false;
    });
    updateCount();
}

// Mettre à jour le compteur de sélection
function updateCount() {
    const checked = document.querySelectorAll('input[name="demandes_selected"]:checked');
    selectedCount = checked.length;
    
    document.getElementById('count-sans-analyse').textContent = selectedCount;
    document.getElementById('submit-count').textContent = selectedCount;
    
    const submitBtn = document.getElementById('btn-submit-lot');
    submitBtn.disabled = selectedCount === 0;
}

// Analyser une seule demande
async function analyserUneSeule(demandeId) {
    console.log('Analyse de la demande:', demandeId);
    
    const btn = document.getElementById(`btn-analyze-${demandeId}`);
    if (!btn) {
        console.error('Bouton non trouvé pour la demande:', demandeId);
        return;
    }
    
    const originalHtml = btn.innerHTML;
    
    // État de chargement
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse...';
    btn.disabled = true;
    
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        showToast('❌ Erreur: Token CSRF manquant', 'error');
        return;
    }
    
    try {
        const url = `/formation/api/analyser-demande/${demandeId}/`;
        console.log('URL de la requête:', url);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        });
        
        console.log('Status de la réponse:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erreur HTTP:', response.status, errorText);
            throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Données reçues:', data);
        
        if (data.success) {
            btn.innerHTML = '<i class="fas fa-check"></i> Analysé';
            btn.className = 'btn btn-sm btn-success';
            
            // Afficher le résultat
            showToast(`✅ Analyse terminée. Score: ${data.score}/100`, 'success');
            
            // Retirer de la liste après un délai
            setTimeout(() => {
                const card = btn.closest('.demande-card');
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.transform = 'scale(0.95)';
                }
            }, 2000);
        } else {
            throw new Error(data.error || 'Erreur inconnue');
        }
    } catch (error) {
        console.error('Erreur lors de l\'analyse:', error);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        showToast(`❌ Erreur: ${error.message}`, 'error');
    }
}

// Réanalyser une demande
async function reanalyser(demandeId) {
    if (!confirm('Voulez-vous vraiment relancer l\'analyse de cette demande ?')) {
        return;
    }
    
    console.log('Réanalyse de la demande:', demandeId);
    
    const btn = document.getElementById(`btn-reanalyze-${demandeId}`);
    if (!btn) {
        console.error('Bouton de réanalyse non trouvé pour la demande:', demandeId);
        return;
    }
    
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> En cours...';
    btn.disabled = true;
    
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        showToast('❌ Erreur: Token CSRF manquant', 'error');
        return;
    }
    
    try {
        // Créer un FormData correct
        const formData = new FormData();
        formData.append('force', 'true');
        
        const url = `/formation/api/analyser-demande/${demandeId}/`;
        console.log('URL de réanalyse:', url);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            body: formData
        });
        
        console.log('Status de la réponse (réanalyse):', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erreur HTTP (réanalyse):', response.status, errorText);
            throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Données reçues (réanalyse):', data);
        
        if (data.success) {
            btn.innerHTML = '<i class="fas fa-check"></i> Terminé';
            btn.className = 'btn btn-sm btn-success';
            showToast(`✅ Réanalyse terminée. Nouveau score: ${data.score}/100`, 'success');
        } else {
            throw new Error(data.error || 'Erreur inconnue');
        }
    } catch (error) {
        console.error('Erreur lors de la réanalyse:', error);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        showToast(`❌ Erreur: ${error.message}`, 'error');
    }
}

// Tester la connexion IA
async function testIaConnection() {
    console.log('Test de connexion IA...');
    
    try {
        const response = await fetch('/formation/admin/test-ia-connection/');
        console.log('Status du test IA:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erreur test IA:', response.status, errorText);
            throw new Error(`Erreur HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Résultat du test IA:', data);
        
        if (data.success) {
            showToast(`✅ ${data.message} - ${data.model}`, 'success');
        } else {
            showToast(`❌ ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('Erreur du test de connexion IA:', error);
        showToast(`❌ Erreur de test: ${error.message}`, 'error');
    }
}

// Fonction utilitaire pour afficher les messages
function showToast(message, type) {
    console.log('Toast:', type, message);
    
    // Créer un toast Bootstrap ou une simple alerte
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto-dismiss après 5 secondes
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initialisation de la page...');
    updateCount();
    
    // Gérer la soumission du formulaire en lot
    const form = document.getElementById('form-analyses-lot');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (selectedCount === 0) {
                e.preventDefault();
                showToast('Veuillez sélectionner au moins une demande', 'error');
                return;
            }
            
            if (!confirm(`Voulez-vous lancer l'analyse IA sur ${selectedCount} demande(s) ?`)) {
                e.preventDefault();
            }
        });
    }
    
    console.log('Initialisation terminée');
});
</script>
{% endblock %}