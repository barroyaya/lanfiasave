{% extends 'formation/base_formation.html' %}
{% load static %}

{% block title %}Historique des Analyses IA{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-separator">/</span>
<a href="{% url 'formation:admin_dashboard' %}" class="breadcrumb-item">Admin</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Historique analyses</span>
{% endblock %}

{% block formation_content %}
<div class="historique-container">
    <!-- Header -->
    <div class="historique-header">
        <div class="header-content">
            <h2 class="historique-title">
                <i class="fas fa-history"></i>
                Historique des Analyses IA
            </h2>
            <p class="historique-subtitle">
                Consultez l'historique complet des analyses automatiques avec filtres avancés
            </p>
        </div>
        
        <div class="header-actions">
            <a href="{% url 'formation:export_rapport' 'analyses_ia' %}" 
               class="btn btn-secondary">
                <i class="fas fa-download"></i> Export CSV
            </a>
            <a href="{% url 'formation:admin_lancer_analyses_lot' %}" 
               class="btn btn-success">
                <i class="fas fa-brain"></i> Nouvelles Analyses
            </a>
            <a href="{% url 'formation:analyses_ia_dashboard' %}" 
               class="btn btn-primary">
                <i class="fas fa-chart-pie"></i> Dashboard IA
            </a>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total }}</div>
                <div class="stat-label">Analyses totales</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.score_moyen|floatformat:1 }}</div>
                <div class="stat-label">Score moyen</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.acceptees_auto }}</div>
                <div class="stat-label">Acceptations auto</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">
                    {% if stats.total > 0 %}
                        {% widthratio stats.acceptees_auto stats.total 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="stat-label">Taux d'acceptation</div>
            </div>
        </div>
    </div>

    <!-- Filtres avancés -->
    <div class="filters-section">
        <div class="filters-header">
            <h3>
                <i class="fas fa-filter"></i>
                Filtres de Recherche
            </h3>
            <button type="button" class="btn btn-outline-secondary btn-sm" 
                    onclick="resetFilters()">
                <i class="fas fa-times"></i> Réinitialiser
            </button>
        </div>
        
        <form method="get" class="filters-form" id="filtersForm">
            <div class="filters-grid">
                <!-- Filtre par score -->
                <div class="filter-group">
                    <label class="filter-label">Score de formabilité</label>
                    <div class="range-inputs">
                        <input type="number" 
                               name="score_min" 
                               placeholder="Min" 
                               min="0" max="100"
                               value="{{ filters.score_min }}"
                               class="form-control form-control-sm">
                        <span class="range-separator">à</span>
                        <input type="number" 
                               name="score_max" 
                               placeholder="Max" 
                               min="0" max="100"
                               value="{{ filters.score_max }}"
                               class="form-control form-control-sm">
                    </div>
                </div>
                
                <!-- Filtre par date -->
                <div class="filter-group">
                    <label class="filter-label">Période d'analyse</label>
                    <div class="date-inputs">
                        <input type="date" 
                               name="date_debut" 
                               value="{{ filters.date_debut }}"
                               class="form-control form-control-sm">
                        <span class="date-separator">à</span>
                        <input type="date" 
                               name="date_fin" 
                               value="{{ filters.date_fin }}"
                               class="form-control form-control-sm">
                    </div>
                </div>
                
                <!-- Filtre par formation -->
                <div class="filter-group">
                    <label class="filter-label">Formation</label>
                    <select name="formation" class="form-select form-select-sm">
                        <option value="">Toutes les formations</option>
                        {% for formation in formations %}
                        <option value="{{ formation.id }}" 
                                {% if filters.formation_id == formation.id|stringformat:"s" %}selected{% endif %}>
                            {{ formation.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Boutons d'action -->
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-search"></i> Rechercher
                    </button>
                    <button type="button" class="btn btn-info btn-sm" 
                            onclick="applyQuickFilter('today')">
                        Aujourd'hui
                    </button>
                    <button type="button" class="btn btn-warning btn-sm" 
                            onclick="applyQuickFilter('week')">
                        7 jours
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Tableau des analyses -->
    <div class="analyses-table-section">
        <div class="table-header">
            <h3>
                <i class="fas fa-table"></i>
                Résultats ({{ analyses.paginator.count }} analyse(s))
            </h3>
            
            <div class="table-actions">
                <div class="view-options">
                    <button class="view-btn active" data-view="table">
                        <i class="fas fa-table"></i> Tableau
                    </button>
                    <button class="view-btn" data-view="cards">
                        <i class="fas fa-th"></i> Cartes
                    </button>
                </div>
            </div>
        </div>
        
        {% if analyses %}
        <!-- Vue tableau -->
        <div class="table-view" id="table-view">
            <div class="table-container">
                <table class="table analyses-table">
                    <thead>
                        <tr>
                            <th>
                                <i class="fas fa-user"></i>
                                Candidat
                            </th>
                            <th>
                                <i class="fas fa-graduation-cap"></i>
                                Formation
                            </th>
                            <th>
                                <i class="fas fa-brain"></i>
                                Score IA
                            </th>
                            <th>
                                <i class="fas fa-calendar"></i>
                                Date Analyse
                            </th>
                            <th>
                                <i class="fas fa-flag"></i>
                                Statut
                            </th>
                            <th>
                                <i class="fas fa-cog"></i>
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analyse in analyses %}
                        <tr class="analyse-row" data-score="{{ analyse.score_formabilite }}">
                            <td>
                                <div class="candidate-cell">
                                    <div class="candidate-name">
                                        {{ analyse.personne.get_full_name }}
                                    </div>
                                    <div class="candidate-meta">
                                        {{ analyse.personne.age }} ans • 
                                        {{ analyse.personne.get_niveau_education_display|default:"N/A" }}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="formation-cell">
                                    <div class="formation-name">
                                        {{ analyse.formation_souhaitee.nom|truncatechars:30 }}
                                    </div>
                                    <div class="formation-type">
                                        {{ analyse.formation_souhaitee.get_type_formation_display }}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="score-cell">
                                    <div class="score-badge score-{{ analyse.score_formabilite|floatformat:0 }}">
                                        {{ analyse.score_formabilite|floatformat:0 }}/100
                                    </div>
                                    <div class="score-interpretation">
                                        {% if analyse.score_formabilite >= 85 %}
                                            <span class="interpretation excellent">Excellent</span>
                                        {% elif analyse.score_formabilite >= 70 %}
                                            <span class="interpretation bon">Bon</span>
                                        {% elif analyse.score_formabilite >= 50 %}
                                            <span class="interpretation moyen">Moyen</span>
                                        {% else %}
                                            <span class="interpretation faible">Faible</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="date-cell">
                                    <div class="date-main">
                                        {{ analyse.date_analyse|date:"d/m/Y" }}
                                    </div>
                                    <div class="date-time">
                                        {{ analyse.date_analyse|time:"H:i" }}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge status-{{ analyse.statut }}">
                                    {{ analyse.get_statut_display }}
                                </span>
                            </td>
                            <td>
                                <div class="actions-cell">
                                    <a href="{% url 'formation:analyse_ia_detail' analyse.id %}" 
                                       class="action-btn btn-view" 
                                       title="Voir analyse détaillée">
                                        <i class="fas fa-brain"></i>
                                    </a>
                                    <a href="{% url 'formation:admin_demande_detail' analyse.id %}" 
                                       class="action-btn btn-edit"
                                       title="Voir la demande">
                                        <i class="fas fa-file-alt"></i>
                                    </a>
                                    <button onclick="reanalyser({{ analyse.id }})"
                                            class="action-btn btn-refresh"
                                            title="Relancer l'analyse">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Vue cartes -->
        <div class="cards-view" id="cards-view" style="display: none;">
            <div class="analyses-cards-grid">
                {% for analyse in analyses %}
                <div class="analyse-card" data-score="{{ analyse.score_formabilite }}">
                    <div class="card-header">
                        <div class="candidate-info">
                            <h4>{{ analyse.personne.get_full_name }}</h4>
                            <p>{{ analyse.personne.age }} ans</p>
                        </div>
                        <div class="score-display">
                            <div class="score-circle score-{{ analyse.score_formabilite|floatformat:0 }}">
                                {{ analyse.score_formabilite|floatformat:0 }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="formation-info">
                            <h5>{{ analyse.formation_souhaitee.nom }}</h5>
                            <p>{{ analyse.formation_souhaitee.get_type_formation_display }}</p>
                        </div>
                        
                        <div class="analysis-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                {{ analyse.date_analyse|date:"d/m/Y H:i" }}
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-flag"></i>
                                {{ analyse.get_statut_display }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <a href="{% url 'formation:analyse_ia_detail' analyse.id %}" 
                           class="btn btn-primary btn-sm">
                            <i class="fas fa-brain"></i> Analyse
                        </a>
                        <a href="{% url 'formation:admin_demande_detail' analyse.id %}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-file-alt"></i> Demande
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Pagination -->
        {% if analyses.has_other_pages %}
        <div class="pagination-container">
            <nav class="pagination-nav">
                {% if analyses.has_previous %}
                    <a href="?page=1{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="page-link">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ analyses.previous_page_number }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="page-link">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}
                
                <span class="page-info">
                    Page {{ analyses.number }} sur {{ analyses.paginator.num_pages }}
                    ({{ analyses.paginator.count }} résultats)
                </span>
                
                {% if analyses.has_next %}
                    <a href="?page={{ analyses.next_page_number }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="page-link">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ analyses.paginator.num_pages }}{% for key, value in filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                       class="page-link">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <!-- Aucun résultat -->
        <div class="no-results">
            <div class="no-results-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>Aucune analyse trouvée</h3>
            <p>
                {% if filters.score_min or filters.score_max or filters.date_debut or filters.date_fin or filters.formation_id %}
                    Aucune analyse ne correspond à vos critères de recherche.
                    <br>
                    <button onclick="resetFilters()" class="btn btn-primary">
                        Réinitialiser les filtres
                    </button>
                {% else %}
                    Aucune analyse IA n'a encore été réalisée.
                    <br>
                    <a href="{% url 'formation:admin_lancer_analyses_lot' %}" class="btn btn-primary">
                        Lancer des analyses
                    </a>
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<style>
.historique-container {
    max-width: 1400px;
    margin: 0 auto;
}

.historique-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 30px;
    border-radius: 16px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.historique-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.historique-subtitle {
    margin: 0;
    opacity: 0.9;
}

.header-actions {
    display: flex;
    gap: 15px;
}

.btn {
    padding: 10px 20px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-primary { background: #3b82f6; color: white; }
.btn-secondary { background: #6b7280; color: white; }
.btn-success { background: #10b981; color: white; }

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s;
}

.stat-card:hover {
    border-color: #8b5cf6;
    transform: translateY(-3px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #8b5cf6;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #1f2937;
    line-height: 1;
}

.stat-label {
    color: #6b7280;
    font-size: 0.9rem;
    margin-top: 5px;
}

.filters-section {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.filters-header h3 {
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-label {
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

.range-inputs, .date-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
}

.range-separator, .date-separator {
    color: #6b7280;
    font-weight: 500;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 0.9rem;
    transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.filter-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 0.85rem;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.table-header h3 {
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.view-options {
    display: flex;
    gap: 5px;
    background: #f3f4f6;
    padding: 5px;
    border-radius: 10px;
}

.view-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: #6b7280;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.view-btn.active, .view-btn:hover {
    background: #8b5cf6;
    color: white;
}

.table-container {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
}

.analyses-table {
    width: 100%;
    margin: 0;
}

.analyses-table th {
    background: #f9fafb;
    color: #374151;
    font-weight: 600;
    padding: 15px;
    border-bottom: 2px solid #e5e7eb;
    font-size: 0.9rem;
}

.analyses-table td {
    padding: 15px;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
}

.candidate-cell, .formation-cell {
    min-width: 150px;
}

.candidate-name, .formation-name {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 3px;
}

.candidate-meta, .formation-type {
    font-size: 0.8rem;
    color: #6b7280;
}

.score-cell {
    text-align: center;
    min-width: 120px;
}

.score-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    color: white;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

/* Score colors */
.score-badge[class*="score-8"], .score-badge[class*="score-9"] { 
    background: #10b981; 
}
.score-badge[class*="score-7"] { 
    background: #3b82f6; 
}
.score-badge[class*="score-5"], .score-badge[class*="score-6"] { 
    background: #f59e0b; 
}
.score-badge[class*="score-0"], .score-badge[class*="score-1"], 
.score-badge[class*="score-2"], .score-badge[class*="score-3"], 
.score-badge[class*="score-4"] { 
    background: #ef4444; 
}

.score-interpretation {
    font-size: 0.75rem;
    font-weight: 600;
}

.interpretation.excellent { color: #10b981; }
.interpretation.bon { color: #3b82f6; }
.interpretation.moyen { color: #f59e0b; }
.interpretation.faible { color: #ef4444; }

.date-cell {
    text-align: center;
    min-width: 100px;
}

.date-main {
    font-weight: 600;
    color: #1f2937;
}

.date-time {
    font-size: 0.8rem;
    color: #6b7280;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-acceptee { background: #d1fae5; color: #065f46; }
.status-refusee { background: #fee2e2; color: #991b1b; }
.status-en_attente { background: #fef3c7; color: #92400e; }
.status-analysee { background: #dbeafe; color: #1e40af; }

.actions-cell {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8rem;
    text-decoration: none;
}

.btn-view { background: #3b82f6; color: white; }
.btn-edit { background: #6b7280; color: white; }
.btn-refresh { background: #f59e0b; color: white; }

.action-btn:hover {
    transform: scale(1.1);
    color: white;
}

.analyses-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
}

.analyse-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s;
}

.analyse-card:hover {
    border-color: #8b5cf6;
    transform: translateY(-5px);
}

.card-header {
    background: #f9fafb;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.candidate-info h4 {
    color: #1f2937;
    margin-bottom: 5px;
}

.candidate-info p {
    color: #6b7280;
    margin: 0;
}

.score-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 1.1rem;
}

.score-circle[class*="score-8"], .score-circle[class*="score-9"] { 
    background: #10b981; 
}
.score-circle[class*="score-7"] { 
    background: #3b82f6; 
}
.score-circle[class*="score-5"], .score-circle[class*="score-6"] { 
    background: #f59e0b; 
}
.score-circle[class*="score-0"], .score-circle[class*="score-1"], 
.score-circle[class*="score-2"], .score-circle[class*="score-3"], 
.score-circle[class*="score-4"] { 
    background: #ef4444; 
}

.card-body {
    padding: 20px;
}

.formation-info h5 {
    color: #1f2937;
    margin-bottom: 5px;
}

.formation-info p {
    color: #6b7280;
    margin-bottom: 15px;
}

.analysis-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: #6b7280;
}

.meta-item i {
    color: #8b5cf6;
    width: 16px;
}

.card-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 10px;
}

.pagination-container {
    margin-top: 30px;
    display: flex;
    justify-content: center;
}

.pagination-nav {
    display: flex;
    align-items: center;
    gap: 15px;
    background: white;
    padding: 15px 25px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.page-link {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    text-decoration: none;
    color: #8b5cf6;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.page-link:hover {
    background: #8b5cf6;
    color: white;
    transform: scale(1.1);
}

.page-info {
    font-weight: 600;
    color: #1f2937;
    white-space: nowrap;
}

.no-results {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
}

.no-results-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}

.no-results h3 {
    color: #1f2937;
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .historique-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }
    
    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .table-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .analyses-table {
        font-size: 0.8rem;
    }
    
    .analyses-cards-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Gestion du changement de vue
document.addEventListener('DOMContentLoaded', function() {
    const viewButtons = document.querySelectorAll('.view-btn');
    const tableView = document.getElementById('table-view');
    const cardsView = document.getElementById('cards-view');
    
    viewButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.dataset.view;
            
            // Mise à jour des boutons
            viewButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Changement de vue
            if (view === 'table') {
                tableView.style.display = 'block';
                cardsView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                cardsView.style.display = 'block';
            }
            
            // Sauvegarder la préférence
            localStorage.setItem('historique_view', view);
        });
    });
    
    // Restaurer la vue préférée
    const savedView = localStorage.getItem('historique_view');
    if (savedView && savedView === 'cards') {
        document.querySelector('[data-view="cards"]').click();
    }
});

// Réinitialiser les filtres
function resetFilters() {
    const form = document.getElementById('filtersForm');
    form.reset();
    
    // Enlever les paramètres de l'URL
    const url = new URL(window.location);
    url.search = '';
    window.history.replaceState({}, '', url);
    
    // Recharger la page
    window.location.reload();
}

// Filtres rapides
function applyQuickFilter(period) {
    const dateDebut = document.querySelector('input[name="date_debut"]');
    const dateFin = document.querySelector('input[name="date_fin"]');
    
    const today = new Date();
    const endDate = today.toISOString().split('T')[0];
    
    let startDate;
    if (period === 'today') {
        startDate = endDate;
    } else if (period === 'week') {
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        startDate = weekAgo.toISOString().split('T')[0];
    }
    
    dateDebut.value = startDate;
    dateFin.value = endDate;
    
    // Soumettre le formulaire
    document.getElementById('filtersForm').submit();
}

// Relancer une analyse
async function reanalyser(demandeId) {
    if (!confirm('Voulez-vous vraiment relancer l\'analyse de cette demande ?')) {
        return;
    }
    
    try {
        const response = await fetch(`/formation/api/lancer-analyse-ajax/${demandeId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: new FormData().append('force', 'true')
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`✅ Réanalyse terminée! Nouveau score: ${data.score}/100`, 'success');
            
            // Recharger la page après un délai
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showNotification(`❌ Erreur: ${data.error}`, 'error');
        }
    } catch (error) {
        showNotification(`❌ Erreur technique: ${error.message}`, 'error');
    }
}

// Système de notifications
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Animation des statistiques au chargement
document.addEventListener('DOMContentLoaded', function() {
    const statNumbers = document.querySelectorAll('.stat-number');
    
    statNumbers.forEach(stat => {
        const finalValue = parseFloat(stat.textContent);
        if (!isNaN(finalValue)) {
            let currentValue = 0;
            const increment = finalValue / 30;
            
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= finalValue) {
                    currentValue = finalValue;
                    clearInterval(timer);
                }
                
                if (stat.textContent.includes('%')) {
                    stat.textContent = currentValue.toFixed(1) + '%';
                } else if (finalValue % 1 === 0) {
                    stat.textContent = Math.round(currentValue);
                } else {
                    stat.textContent = currentValue.toFixed(1);
                }
            }, 50);
        }
    });
});
</script>
{% endblock %}